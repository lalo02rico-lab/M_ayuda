<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de servicios - Mesa de Ayuda</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/admin_gservicios.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>

<body>

<header class="app-header">
    <div class="header-container">
        <div class="logos">
            <img src="/img/logo_gobierno.png" alt="Gobierno del Estado de M√©xico">
        </div>
        <a href="/admin/menu" class="btn-back">‚Üê Volver</a>
        <a href="/logout" class="btn-logout">Cerrar sesi√≥n</a>
    </div>
</header>

<main class="admin-layout">

    <aside class="sidebar"></aside>

    <section class="content">
        <div class="gestion-servicios-container">

            <!-- ===== MEN√ö ===== -->
            <div class="servicios-menu">
                <a th:href="@{/admin/gestion-servicios(categoria='resguardos')}"
                   th:classappend="${categoria=='resguardos'}?'active':''">Resguardos</a>

                <a th:href="@{/admin/gestion-servicios(categoria='correos')}"
                   th:classappend="${categoria=='correos'}?'active':''">Correos</a>

                <a th:href="@{/admin/gestion-servicios(categoria='licencias')}"
                   th:classappend="${categoria=='licencias'}?'active':''">Licencias</a>

                <a th:href="@{/admin/gestion-servicios(categoria='extenciones')}"
                   th:classappend="${categoria=='extenciones'}?'active':''">Extenciones</a>

                <a th:href="@{/admin/gestion-servicios(categoria='inventarios')}"
                   th:classappend="${categoria=='inventarios'}?'active':''">Inventarios</a>
            </div>

            <div class="servicios-panel">

                <!-- ================= FILTROS / BUSCADOR ================= -->
                <div class="buscador">
                    <form method="get" th:action="@{/admin/gestion-servicios}" class="filtros-form">
                        <input type="hidden" name="categoria" th:value="${categoria}">

                        <!-- filtro solo resguardos -->
                        <select name="tipo" th:if="${categoria=='resguardos'}">
                            <option value="">Todos</option>
                            <option value="ESCRITORIO_BASICO"   th:selected="${tipo=='ESCRITORIO_BASICO'}">Escritorio b√°sico</option>
                            <option value="MOVIL_AVANZADO"      th:selected="${tipo=='MOVIL_AVANZADO'}">M√≥vil avanzado</option>
                            <option value="ESCRITORIO_AVANZADO" th:selected="${tipo=='ESCRITORIO_AVANZADO'}">Escritorio avanzado</option>
                            <option value="MOVIL_MEDIO"         th:selected="${tipo=='MOVIL_MEDIO'}">M√≥vil medio</option>
                            <option value="PORTATIL_DONADO"     th:selected="${tipo=='PORTATIL_DONADO'}">Port√°til donado</option>
                        </select>

                        <input type="text" name="q"
                               placeholder="Buscar por usuario, √°rea, correo, serie, modelo‚Ä¶"
                               th:value="${q}">
                        <button type="submit">Buscar</button>
                    </form>
                </div>

                <!-- ================= ACCIONES ================= -->
                <div class="acciones">
                    <button class="btn-agregar"
                            th:if="${categoria!='resguardos'}"
                            th:data-categoria="${categoria}"
                            onclick="abrirModalAgregar(this)">
                        ‚ûï Agregar
                    </button>

                    <a th:href="@{/admin/descargar-pdf(
                               categoria=${categoria},
                               tipo=${tipo},
                               q=${q}
                              )}"
                       class="btn-descargar">
                        Descargar PDF
                    </a>
                </div>

                <!-- ================= TABLAS ================= -->
                <div class="resultado-box">

                    <!-- ================= RESGUARDOS ================= -->
                    <table th:if="${categoria=='resguardos'}">
                        <thead>
                        <tr>
                            <th>No</th><th>Tipo</th><th>Usuario</th><th>Usuario final</th>
                            <th>Direcci√≥n</th><th>√Årea</th><th>Perfil</th>
                            <th>Modelo</th><th>Serie CPU</th><th>Status</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="r : ${resguardos}">
                            <td th:text="${r.no}"></td>
                            <td th:text="${r.tipoEquipo}"></td>
                            <td th:text="${r.usuario}"></td>
                            <td th:text="${r.usuarioFinal}"></td>
                            <td th:text="${r.direccion}"></td>
                            <td th:text="${r.area}"></td>
                            <td th:text="${r.perfilEquipo}"></td>
                            <td th:text="${r.modelo}"></td>
                            <td th:text="${r.serieCpu}"></td>
                            <td th:text="${r.status}"></td>
                        </tr>
                        </tbody>
                    </table>

                    <!-- ================= CORREOS ================= -->
                    <table th:if="${categoria=='correos'}">
                        <thead>
                        <tr>
                            <th>Usuario</th><th>Correo</th><th>Licencia</th><th>√Årea</th><th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="c : ${correos}">
                            <td th:text="${c.usuario}"></td>
                            <td th:text="${c.correo}"></td>
                            <td th:text="${c.tipoLicencia}"></td>
                            <td th:text="${c.area}"></td>
                            <td>
                                <button th:data-id="${c.id}" data-categoria="correos"
                                        onclick="abrirModalEditar(this)">‚úèÔ∏è</button>
                                <button th:data-id="${c.id}" data-categoria="correos"
                                        onclick="eliminarRegistro(this)">üóëÔ∏è</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <!-- ================= LICENCIAS ================= -->
                    <table th:if="${categoria=='licencias'}">
                        <thead>
                        <tr>
                            <th>Usuario</th><th>√Årea</th><th>Total</th><th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="l : ${licencias}">
                            <td th:text="${l.usuario}"></td>
                            <td th:text="${l.area}"></td>
                            <td th:text="${l.totalLicencias}"></td>
                            <td>
                                <button th:data-id="${l.id}" data-categoria="licencias"
                                        onclick="abrirModalEditar(this)">‚úèÔ∏è</button>
                                <button th:data-id="${l.id}" data-categoria="licencias"
                                        onclick="eliminarRegistro(this)">üóëÔ∏è</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <!-- ================= EXTENCIONES ================= -->
                    <table th:if="${categoria=='extenciones'}">
                        <thead>
                        <tr>
                            <th>Ext</th><th>Nombre</th><th>Departamento</th><th>Correo</th><th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="e : ${extenciones}">
                            <td th:text="${e.id}"></td>
                            <td th:text="${e.nombre}"></td>
                            <td th:text="${e.departamento}"></td>
                            <td th:text="${e.correo}"></td>
                            <td>
                                <button th:data-id="${e.id}" data-categoria="extenciones"
                                        onclick="abrirModalEditar(this)">‚úèÔ∏è</button>
                                <button th:data-id="${e.id}" data-categoria="extenciones"
                                        onclick="eliminarRegistro(this)">üóëÔ∏è</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <!-- ================= INVENTARIOS ================= -->
                    <table th:if="${categoria=='inventarios'}">
                        <thead>
                        <tr>
                            <th>Inventario</th><th>NIC</th><th>Descripci√≥n</th><th>Valor</th>
                            <th>Marca</th><th>Modelo</th><th>Serie</th>
                            <th>Clave dependencia</th><th>Dependencia</th>
                            <th>Resguardatario</th><th>Inmueble</th><th>Proveedor</th>
                            <th>Estado de uso</th><th>Fecha adquisici√≥n</th>
                            <th>Fecha asignaci√≥n</th><th>Fecha firma resguardo</th>
                            <th>Sal. m√≠n. UMA</th><th>Tipo propiedad</th>
                            <th>Forma adquisici√≥n</th><th>Tipo documento</th>
                            <th>Caracter√≠sticas</th><th>Material</th><th>Color</th>
                            <th>Tipo asignaci√≥n</th><th>Placas</th>
                            <th>Activo gen√©rico</th><th>Grupo activo</th>
                            <th>Activo espec√≠fico</th><th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="i : ${inventarios}">
                            <td th:text="${i.inventario}"></td>
                            <td th:text="${i.nic}"></td>
                            <td th:text="${i.descripcionBien}"></td>
                            <td th:text="${i.valor}"></td>
                            <td th:text="${i.marca}"></td>
                            <td th:text="${i.modelo}"></td>
                            <td th:text="${i.serie}"></td>
                            <td th:text="${i.claveDependencia}"></td>
                            <td th:text="${i.nombreDependencia}"></td>
                            <td th:text="${i.resguardatario}"></td>
                            <td th:text="${i.nombreInmueble}"></td>
                            <td th:text="${i.proveedor}"></td>
                            <td th:text="${i.estadoUso}"></td>
                            <td th:text="${i.fechaAdquisicion != null ? #temporals.format(i.fechaAdquisicion,'dd/MM/yyyy') : ''}"></td>
                            <td th:text="${i.fechaAsignacion != null ? #temporals.format(i.fechaAsignacion,'dd/MM/yyyy') : ''}"></td>
                            <td th:text="${i.fechaFirmaResg != null ? #temporals.format(i.fechaFirmaResg,'dd/MM/yyyy') : ''}"></td>
                            <td th:text="${i.salMinUma}"></td>
                            <td th:text="${i.tipoPropiedad}"></td>
                            <td th:text="${i.formaAdquisicion}"></td>
                            <td th:text="${i.tipoDocumento}"></td>
                            <td th:text="${i.caracteristicas}"></td>
                            <td th:text="${i.material}"></td>
                            <td th:text="${i.color}"></td>
                            <td th:text="${i.tipoAsignacion}"></td>
                            <td th:text="${i.placas}"></td>
                            <td th:text="${i.activoGenerico}"></td>
                            <td th:text="${i.grupoActivo}"></td>
                            <td th:text="${i.activoEspecifico}"></td>
                            <td>
                                <button th:data-id="${i.inventario}" data-categoria="inventarios"
                                        onclick="abrirModalEditar(this)">‚úèÔ∏è</button>
                                <button th:data-id="${i.inventario}" data-categoria="inventarios"
                                        onclick="eliminarRegistro(this)">üóëÔ∏è</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                </div>

                <!-- ================= PAGINACI√ìN ================= -->
                <div class="paginacion" th:if="${totalPages > 1}">

                    <!-- ANTERIOR -->
                    <a class="nav"
                       th:if="${currentPage > 0}"
                       th:href="@{/admin/gestion-servicios(
           categoria=${categoria},
           tipo=${tipo},
           q=${q},
           page=${currentPage - 1}
       )}">
                        ‚Äπ
                    </a>

                    <!-- N√öMEROS (SOLO 3 DIN√ÅMICOS) -->
                    <span th:each="i : ${#numbers.sequence(
            T(java.lang.Math).max(0, currentPage - 1),
            T(java.lang.Math).min(totalPages - 1, currentPage + 1)
        )}">
        <a th:href="@{/admin/gestion-servicios(
                categoria=${categoria},
                tipo=${tipo},
                q=${q},
                page=${i}
            )}"
           th:text="${i + 1}"
           th:classappend="${i == currentPage} ? 'active' : ''">
        </a>
    </span>

                    <!-- SIGUIENTE -->
                    <a class="nav"
                       th:if="${currentPage < totalPages - 1}"
                       th:href="@{/admin/gestion-servicios(
           categoria=${categoria},
           tipo=${tipo},
           q=${q},
           page=${currentPage + 1}
       )}">
                        ‚Ä∫
                    </a>

                </div>


            </div>
        </div>
    </section>
</main>

<!-- ===== MODAL ===== -->
<div id="modalCrud" class="modal hidden">
    <div class="modal-content">
        <h3 id="modalTitulo"></h3>

        <form method="post" action="/admin/guardar">
            <input type="hidden" name="categoria" id="categoria">
            <input type="hidden" name="id" id="registroId">
            <div id="camposFormulario"></div>

            <button type="submit">Guardar</button>
            <button type="button" onclick="cerrarModal()">Cancelar</button>
        </form>
    </div>
</div>

<script>
    function abrirModalAgregar(btn){
        const c = btn.dataset.categoria;
        document.getElementById('modalTitulo').innerText='Agregar';
        document.getElementById('categoria').value=c;
        document.getElementById('registroId').value='';
        cargarCampos(c,{});
        document.getElementById('modalCrud').classList.remove('hidden');
    }

    function abrirModalEditar(btn){
        const id = btn.dataset.id;
        const c  = btn.dataset.categoria;

        fetch(`/admin/obtener/${c}/${encodeURIComponent(id)}`)
            .then(r=>r.json())
            .then(d=>{
                document.getElementById('modalTitulo').innerText='Editar';
                document.getElementById('categoria').value=c;
                document.getElementById('registroId').value=id;
                cargarCampos(c,d);
                document.getElementById('modalCrud').classList.remove('hidden');
            });
    }

    function eliminarRegistro(btn){
        if(!confirm('¬øEliminar registro?')) return;

        fetch('/admin/eliminar',{
            method:'POST',
            headers:{'Content-Type':'application/x-www-form-urlencoded'},
            body:`categoria=${btn.dataset.categoria}&id=${encodeURIComponent(btn.dataset.id)}`
        }).then(()=>location.reload());
    }

    function cerrarModal(){
        document.getElementById('modalCrud').classList.add('hidden');
    }

    function cargarCampos(c,d){
        let h='';
        if(c==='correos'){
            h=`<input name="usuario" value="${d.usuario||''}">
               <input name="correo" value="${d.correo||''}">
               <input name="tipoLicencia" value="${d.tipoLicencia||''}">
               <input name="area" value="${d.area||''}">`;
        }
        if(c==='licencias'){
            h=`<input name="usuario" value="${d.usuario||''}">
               <input name="area" value="${d.area||''}">
               <input type="number" name="totalLicencias" value="${d.totalLicencias||0}">`;
        }
        if(c==='extenciones'){
            h=`<input name="nombre" value="${d.nombre||''}">
               <input name="departamento" value="${d.departamento||''}">
               <input name="correo" value="${d.correo||''}">`;
        }
       if(c === 'inventarios'){
    h = `
    <label>Inventario</label>
    <input name="inventario" value="${d.inventario||''}" readonly>

    <label>NIC</label>
    <input name="nic" value="${d.nic||''}">

    <label>Descripci√≥n</label>
    <input name="descripcionBien" value="${d.descripcionBien||''}">

    <label>Valor</label>
    <input name="valor" value="${d.valor||''}">

    <label>Marca</label>
    <input name="marca" value="${d.marca||''}">

    <label>Modelo</label>
    <input name="modelo" value="${d.modelo||''}">

    <label>Serie</label>
    <input name="serie" value="${d.serie||''}">

    <label>Clave dependencia</label>
    <input name="claveDependencia" value="${d.claveDependencia||''}">

    <label>Dependencia</label>
    <input name="nombreDependencia" value="${d.nombreDependencia||''}">

    <label>Resguardatario</label>
    <input name="resguardatario" value="${d.resguardatario||''}">

    <label>Inmueble</label>
    <input name="nombreInmueble" value="${d.nombreInmueble||''}">

    <label>Proveedor</label>
    <input name="proveedor" value="${d.proveedor||''}">

    <label>Estado de uso</label>
    <input name="estadoUso" value="${d.estadoUso||''}">

    <label>Fecha adquisici√≥n</label>
    <input type="date" name="fechaAdquisicion" value="${d.fechaAdquisicion||''}">

    <label>Fecha asignaci√≥n</label>
    <input type="date" name="fechaAsignacion" value="${d.fechaAsignacion||''}">

    <label>Fecha firma resguardo</label>
    <input type="date" name="fechaFirmaResg" value="${d.fechaFirmaResg||''}">

    <label>Salario m√≠nimo UMA</label>
    <input name="salMinUma" value="${d.salMinUma||''}">

    <label>Tipo propiedad</label>
    <input name="tipoPropiedad" value="${d.tipoPropiedad||''}">

    <label>Forma adquisici√≥n</label>
    <input name="formaAdquisicion" value="${d.formaAdquisicion||''}">

    <label>Tipo documento</label>
    <input name="tipoDocumento" value="${d.tipoDocumento||''}">

    <label>Caracter√≠sticas</label>
    <input name="caracteristicas" value="${d.caracteristicas||''}">

    <label>Material</label>
    <input name="material" value="${d.material||''}">

    <label>Color</label>
    <input name="color" value="${d.color||''}">

    <label>Tipo asignaci√≥n</label>
    <input name="tipoAsignacion" value="${d.tipoAsignacion||''}">

    <label>Placas</label>
    <input name="placas" value="${d.placas||''}">

    <label>Activo gen√©rico</label>
    <input name="activoGenerico" value="${d.activoGenerico||''}">

    <label>Grupo activo</label>
    <input name="grupoActivo" value="${d.grupoActivo||''}">

    <label>Activo espec√≠fico</label>
    <input name="activoEspecifico" value="${d.activoEspecifico||''}">
    `;
}
        document.getElementById('camposFormulario').innerHTML=h;
    }
</script>

</body>
</html>
